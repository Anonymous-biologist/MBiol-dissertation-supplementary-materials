---
title: "Movement Analysis"
date: "2023-04-17"
output: html_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load necessary packages
```{r}
library(afex) # for coefficient p-values to be shown in the mixed model summary
library(dplyr) # for various useful data manipulation functions
library(emmeans) # for comparing slopes between groups over time in a linear model
library(ggfortify) # for extracting survival probabilities over time
library(lme4) # for mixed modelling
library(RColorBrewer) # for colourblind-friendly palettes
library(reshape) # for reshaping data
library(stringr) # for str_replace_all() function
library(survival) # for log-rank test
library(tidyverse) # for a plethora of packages that have the same "design philosophy, grammar, and data structures" for work with tidy data
```

# Read in the movement quantification data
```{r}
mov = read_csv("D:/Oxford/4th-year Project/Results/Movement.csv")
```

# Remove unneeded columns
```{r}
# First, rename columns with problematic names so that they can be specified for removal
mov = dplyr::rename(mov, "First_frame" = "1stFrame", "Number_of_frames" = "#Frames")

# Remove columns that area not needed
mov = subset(mov, select = -c(Track, Number_of_frames, First_frame, avgX, avgY))
```

# Add contamination data
```{r}
# Load lifespan data
lifespan = read_csv("D:/Oxford/4th-year Project/Results/Lifespan.csv")

# Replace "_" with "+" in the lifespan data so that the group names match those in the fluorescence data
lifespan = lifespan %>% mutate(Group = str_replace_all(Group, "_", "+"))

# Add columns from lifespan data to movement data when matching by group and plate
mov = inner_join(mov, lifespan, by = c("Group", "Plate"), multiple = "first")
```

# Clean and format the merged data
```{r}
# Remove unnecessary columns
mov = subset(mov, select = -c(GroupNum, Worm.y, PlateGroup, Time, Censoring, NaturalDeath))

# Rename the leftover worm column that became "Worm.x" when the data sets were joined
mov = dplyr::rename(mov, "Worm" = "Worm.x")

# Make the "Group" and "Plate" variables factors
mov$Group = as.factor(mov$Group)
mov$Plate = as.factor(mov$Plate)

# Create a new column that concatenates the group and plate variables
mov$GroupPlate = paste(mov[["Group"]], mov[["Plate"]], sep = "_", collapse = NULL)

# Add a space on either side of the "+" in the Group names
mov = mov %>% mutate(Group = str_replace_all(Group, "\\+", " + "))

# Reorder the groups in a more logical way
mov = mutate(mov, Group = fct_relevel(Group, "Control", "MET", "NMN", "CR", "MET + NMN", "MET + CR", "NMN + CR", "MET + NMN + CR"))
```

# Create a colour blind friendly palette
```{r}
# Have a look at the available colour blind friendly palettes
display.brewer.all(colorblindFriendly = TRUE)

# See the HEX codes for the chosen colour blind-friendly palette
brewer.pal(12, "Paired")

# Specify the colours for each group - Dark2 palette
cb_friendly_palette = c("Control" = "#FF7F00", "MET" = "#B2DF8A", "NMN" = "#A6CEE3", "CR" = "#FB9A99", "MET + NMN" = "#33A02C", "MET + CR" = "#E31A1C", "NMN + CR" = "#1F78B4", "MET + NMN + CR" = "#000000")
```

# ARTEFACTS NOT REMOVED: Create three new data frames (one for all worms, irrespective of contamination level, one for the worms in the "Low" contamination group, and one for the worms in the "High" contamination group) that contain the movement data for the worms on each plate over time. Plot the data for each data frame to see the movement trends for each treatment group over time.

## Not log-transformed speed variables

### All worms
```{r}
# Creating the new data frame for all worms, irrespective of contamination level
mov_summary_all = mov %>% group_by(Group, Day) %>% 
  summarise(Mean_length = mean(Length), 
            Error_mean_length = qnorm(0.975)*sd(Length)/sqrt(n()), 
            Mean_distance = mean(Distance), 
            Error_mean_distance = qnorm(0.975)*sd(Distance)/sqrt(n()), 
            Mean_max_speed = mean(MaxSpeed), 
            Error_mean_max_speed = qnorm(0.975)*sd(MaxSpeed)/sqrt(n()), 
            Mean_avg_speed = mean(AvgSpeed), 
            Error_mean_avg_speed = qnorm(0.975)*sd(AvgSpeed)/sqrt(n()), 
            Mean_avg_area = mean(AvgArea), 
            Error_mean_avg_area = qnorm(0.975)*sd(AvgArea)/sqrt(n()), 
            Mean_avg_perim = mean(AvgPerim), 
            Error_mean_avg_perim = qnorm(0.975)*sd(AvgPerim)/sqrt(n()), 
            Mean_BLPS = mean(BLPS), 
            Error_mean_BLPS = qnorm(0.975)*sd(BLPS)/sqrt(n()), 
            Broad_cat = Ind_vs_Comb[1])

# Plot the data for average speed
ggplot(mov_summary_all, aes(x = Day, y = Mean_avg_speed, colour = Group, 
                            ymin = Mean_avg_speed - Error_mean_avg_speed, 
                            ymax = Mean_avg_speed + Error_mean_avg_speed)) +
  geom_point() +
  geom_line(aes(group = Group)) +
  geom_errorbar(width = 0.2) +
  scale_colour_manual(values = cb_friendly_palette)

# Plot the data for max speed
ggplot(mov_summary_all, aes(x = Day, y = Mean_max_speed, colour = Group, 
                            ymin = Mean_max_speed - Error_mean_max_speed, 
                            ymax = Mean_max_speed + Error_mean_max_speed)) +
  geom_point() +
  geom_line(aes(group = Group)) +
  geom_errorbar(width = 0.2) +
  scale_colour_manual(values = cb_friendly_palette)
```

### LOW contaminaton
```{r}
# Include only worms on plates with "Low" contamination
mov_low = filter(mov, Contam_Level_Binary == "Low")
```

### Change in group means over time

Create a new data frame with the change in group means over time
```{r}
mov_summary_low = mov_low %>% group_by(Group, Day) %>% 
  summarise(Mean_length = mean(Length), 
            Error_mean_length = qnorm(0.975)*sd(Length)/sqrt(n()), 
            Mean_distance = mean(Distance), 
            Error_mean_distance = qnorm(0.975)*sd(Distance)/sqrt(n()), 
            Mean_max_speed = mean(MaxSpeed), 
            Error_mean_max_speed = qnorm(0.975)*sd(MaxSpeed)/sqrt(n()), 
            Mean_avg_speed = mean(AvgSpeed), 
            Error_mean_avg_speed = qnorm(0.975)*sd(AvgSpeed)/sqrt(n()), 
            Mean_avg_area = mean(AvgArea), 
            Error_mean_avg_area = qnorm(0.975)*sd(AvgArea)/sqrt(n()), 
            Mean_avg_perim = mean(AvgPerim), 
            Error_mean_avg_perim = qnorm(0.975)*sd(AvgPerim)/sqrt(n()), 
            Mean_BLPS = mean(BLPS), 
            Error_mean_BLPS = qnorm(0.975)*sd(BLPS)/sqrt(n()), 
            Broad_cat = Ind_vs_Comb[1])
```

##### All groups on same plot

###### Average speed
```{r}
ggplot(mov_summary_low, aes(x = Day, y = Mean_avg_speed, colour = Group, 
                            ymin = Mean_avg_speed - Error_mean_avg_speed, 
                            ymax = Mean_avg_speed + Error_mean_avg_speed)) +
  geom_point() +
  geom_line(aes(group = Group)) +
  geom_errorbar(width = 0.2) +
  scale_colour_manual(values = cb_friendly_palette)
```

###### Max speed
```{r}
ggplot(mov_summary_low, aes(x = Day, y = Mean_max_speed, colour = Group, 
                            ymin = Mean_max_speed - Error_mean_max_speed, 
                            ymax = Mean_max_speed + Error_mean_max_speed)) +
  geom_point() +
  geom_line(aes(group = Group)) +
  geom_errorbar(width = 0.2) +
  scale_colour_manual(values = cb_friendly_palette)
```

##### Each group in separate facet

###### Average speed
```{r}
ggplot(mov_summary_low, aes(x = Day, y = Mean_avg_speed, colour = Group, 
                            ymin = Mean_avg_speed - Error_mean_avg_speed, 
                            ymax = Mean_avg_speed + Error_mean_avg_speed)) +
  geom_point() +
  geom_line(aes(group = Group)) +
  geom_errorbar(width = 0.2) +
  facet_wrap(~Group) +
  scale_colour_manual(values = cb_friendly_palette)
```

###### Max speed
```{r}
ggplot(mov_summary_low, aes(x = Day, y = Mean_max_speed, colour = Group, 
                            ymin = Mean_max_speed - Error_mean_max_speed, 
                            ymax = Mean_max_speed + Error_mean_max_speed)) +
  geom_point() +
  geom_line(aes(group = Group)) +
  geom_errorbar(width = 0.2) +
  facet_wrap(~Group) +
  scale_colour_manual(values = cb_friendly_palette)
```

### All data points

##### Average speed
```{r}
ggplot(mov_low, aes(x = Day, y = AvgSpeed, colour = Group)) +
  geom_point() +
  facet_wrap(~Group) +
  scale_colour_manual(values = cb_friendly_palette)
```

##### Max speed
```{r}
ggplot(mov_low, aes(x = Day, y = MaxSpeed, colour = Group)) +
  geom_point() +
  facet_wrap(~Group) +
  scale_colour_manual(values = cb_friendly_palette)
```


### NOT USED - HIGH contaminaton
```{r}
# Include only worms on plates with "Low" contamination
mov_high = filter(mov, Contam_Level_Binary == "High")

# Creating the new data frame for all worms, irrespective of contamination level
mov_summary_high = mov_high %>% group_by(Group, Day) %>% 
  summarise(Mean_length = mean(Length), 
            Error_mean_length = qnorm(0.975)*sd(Length)/sqrt(n()), 
            Mean_distance = mean(Distance), 
            Error_mean_distance = qnorm(0.975)*sd(Distance)/sqrt(n()), 
            Mean_max_speed = mean(MaxSpeed), 
            Error_mean_max_speed = qnorm(0.975)*sd(MaxSpeed)/sqrt(n()), 
            Mean_avg_speed = mean(AvgSpeed), 
            Error_mean_avg_speed = qnorm(0.975)*sd(AvgSpeed)/sqrt(n()), 
            Mean_avg_area = mean(AvgArea), 
            Error_mean_avg_area = qnorm(0.975)*sd(AvgArea)/sqrt(n()), 
            Mean_avg_perim = mean(AvgPerim), 
            Error_mean_avg_perim = qnorm(0.975)*sd(AvgPerim)/sqrt(n()), 
            Mean_BLPS = mean(BLPS), 
            Error_mean_BLPS = qnorm(0.975)*sd(BLPS)/sqrt(n()), 
            Broad_cat = Ind_vs_Comb[1])

# Plot the data for average speed
ggplot(mov_summary_high, aes(x = Day, y = Mean_avg_speed, colour = Group, 
                            ymin = Mean_avg_speed - Error_mean_avg_speed, 
                            ymax = Mean_avg_speed + Error_mean_avg_speed)) +
  geom_point() +
  geom_line(aes(group = Group)) +
  geom_errorbar(width = 0.2) +
  scale_colour_manual(values = cb_friendly_palette)

# Plot the data for max speed
ggplot(mov_summary_high, aes(x = Day, y = Mean_max_speed, colour = Group, 
                            ymin = Mean_max_speed - Error_mean_max_speed, 
                            ymax = Mean_max_speed + Error_mean_max_speed)) +
  geom_point() +
  geom_line(aes(group = Group)) +
  geom_errorbar(width = 0.2) +
  scale_colour_manual(values = cb_friendly_palette)
```

## Log-transformed speed variables

### All worms
```{r}
# Creating the new data frame for all worms, irrespective of contamination level
mov_summary_all_logged = mov %>% group_by(Group, Day) %>% 
  summarise(Mean_length = mean(Length), 
            Error_mean_length = qnorm(0.975)*sd(Length)/sqrt(n()), 
            Mean_distance = mean(Distance), 
            Error_mean_distance = qnorm(0.975)*sd(Distance)/sqrt(n()), 
            Mean_log_max_speed = mean(log(MaxSpeed)), 
            Error_mean_log_max_speed = qnorm(0.975)*sd(log(MaxSpeed))/sqrt(n()), 
            Mean_log_avg_speed = mean(log(AvgSpeed)), 
            Error_mean_log_avg_speed = qnorm(0.975)*sd(log(AvgSpeed))/sqrt(n()), 
            Mean_avg_area = mean(AvgArea), 
            Error_mean_avg_area = qnorm(0.975)*sd(AvgArea)/sqrt(n()), 
            Mean_avg_perim = mean(AvgPerim), 
            Error_mean_avg_perim = qnorm(0.975)*sd(AvgPerim)/sqrt(n()), 
            Mean_log_BLPS = mean(log(BLPS)), 
            Error_mean_log_BLPS = qnorm(0.975)*sd(log(BLPS))/sqrt(n()), 
            Broad_cat = Ind_vs_Comb[1])

# Plot the data for average speed
ggplot(mov_summary_all_logged, aes(x = Day, y = Mean_log_avg_speed, colour = Group, 
                                   ymin = Mean_log_avg_speed - Error_mean_log_avg_speed, 
                                   ymax = Mean_log_avg_speed + Error_mean_log_avg_speed)) +
  geom_point() +
  geom_line(aes(group = Group)) +
  geom_errorbar(width = 0.2) +
  scale_colour_manual(values = cb_friendly_palette)

# Plot the data for max speed
ggplot(mov_summary_all_logged, aes(x = Day, y = Mean_log_max_speed, colour = Group, 
                                   ymin = Mean_log_max_speed - Error_mean_log_max_speed, 
                                   ymax = Mean_log_max_speed + Error_mean_log_max_speed)) +
  geom_point() +
  geom_line(aes(group = Group)) +
  geom_errorbar(width = 0.2) +
  scale_colour_manual(values = cb_friendly_palette)
```

### LOW contaminaton
```{r}
# Include only worms on plates with "Low" contamination
mov_low = filter(mov, Contam_Level_Binary == "Low")
```

### Change in group means over time

Create a new data frame with the change in group means over time
```{r}
mov_summary_low_logged = mov_low %>% group_by(Group, Day) %>% 
  summarise(Mean_length = mean(Length), 
            Error_mean_length = qnorm(0.975)*sd(Length)/sqrt(n()), 
            Mean_distance = mean(Distance), 
            Error_mean_distance = qnorm(0.975)*sd(Distance)/sqrt(n()), 
            Mean_log_max_speed = mean(log(MaxSpeed)), 
            Error_mean_log_max_speed = qnorm(0.975)*sd(log(MaxSpeed))/sqrt(n()), 
            Mean_log_avg_speed = mean(log(AvgSpeed)), 
            Error_mean_log_avg_speed = qnorm(0.975)*sd(log(AvgSpeed))/sqrt(n()), 
            Mean_avg_area = mean(AvgArea), 
            Error_mean_avg_area = qnorm(0.975)*sd(AvgArea)/sqrt(n()), 
            Mean_avg_perim = mean(AvgPerim), 
            Error_mean_avg_perim = qnorm(0.975)*sd(AvgPerim)/sqrt(n()), 
            Mean_log_BLPS = mean(log(BLPS)), 
            Error_mean_log_BLPS = qnorm(0.975)*sd(log(BLPS))/sqrt(n()), 
            Broad_cat = Ind_vs_Comb[1])
```

##### All groups on same plot

###### Average speed
```{r}
ggplot(mov_summary_low_logged, aes(x = Day, y = Mean_log_avg_speed, colour = Group, 
                                   ymin = Mean_log_avg_speed - Error_mean_log_avg_speed, 
                                   ymax = Mean_log_avg_speed + Error_mean_log_avg_speed)) +
  geom_point() +
  geom_line(aes(group = Group)) +
  geom_errorbar(width = 0.2) +
  scale_colour_manual(values = cb_friendly_palette)
```

###### Max speed
```{r}
ggplot(mov_summary_low_logged, aes(x = Day, y = Mean_log_max_speed, colour = Group, 
                                   ymin = Mean_log_max_speed - Error_mean_log_max_speed, 
                                   ymax = Mean_log_max_speed + Error_mean_log_max_speed)) +
  geom_point() +
  geom_line(aes(group = Group)) +
  geom_errorbar(width = 0.2) +
  scale_colour_manual(values = cb_friendly_palette)
```

##### Each group in separate facet

###### Average speed
```{r}
ggplot(mov_summary_low_logged, aes(x = Day, y = Mean_log_avg_speed, colour = Group, 
                                   ymin = Mean_log_avg_speed - Error_mean_log_avg_speed, 
                                   ymax = Mean_log_avg_speed + Error_mean_log_avg_speed)) +
  geom_point() +
  geom_line(aes(group = Group)) +
  geom_errorbar(width = 0.2) +
  facet_wrap(~Group) +
  scale_colour_manual(values = cb_friendly_palette)
```

###### Max speed
```{r}
ggplot(mov_summary_low_logged, aes(x = Day, y = Mean_log_max_speed, colour = Group, 
                                   ymin = Mean_log_max_speed - Error_mean_log_max_speed, 
                                   ymax = Mean_log_max_speed + Error_mean_log_max_speed)) +
  geom_point() +
  geom_line(aes(group = Group)) +
  geom_errorbar(width = 0.2) +
  facet_wrap(~Group) +
  scale_colour_manual(values = cb_friendly_palette)
```

### All data points

##### Average speed
```{r}
ggplot(mov_low, aes(x = Day, y = log(AvgSpeed), colour = Group)) +
  geom_point() +
  facet_wrap(~Group) +
  scale_colour_manual(values = cb_friendly_palette)
```

##### Max speed
```{r}
ggplot(mov_low, aes(x = Day, y = log(MaxSpeed), colour = Group)) +
  geom_point() +
  facet_wrap(~Group) +
  scale_colour_manual(values = cb_friendly_palette)
```

# ARTEFACTS REMOVED from LOW contamination group

## Remove the 7 observations with a maximum speed of >0.9, as these are artefacts resulting from the merger of the worm thresholded area with another thresholded area
```{r}
mov_low_cleaned = filter(mov_low, MaxSpeed <= 0.9)
```

## Calculate sample sizes per group for the cleaned data
```{r}
mov_low_cleaned %>% group_by(Group) %>% summarise(N = n())
```

## Not log-transformed

### Change in group means over time

Create a new data frame with the change in group means over time
```{r}
mov_summary_low_cleaned = mov_low_cleaned %>% group_by(Group, Day) %>% 
  summarise(Mean_length = mean(Length), 
            Error_mean_length = qnorm(0.975)*sd(Length)/sqrt(n()), 
            Mean_distance = mean(Distance), 
            Error_mean_distance = qnorm(0.975)*sd(Distance)/sqrt(n()), 
            Mean_max_speed = mean(MaxSpeed), 
            Error_mean_max_speed = qnorm(0.975)*sd(MaxSpeed)/sqrt(n()), 
            Mean_avg_speed = mean(AvgSpeed), 
            Error_mean_avg_speed = qnorm(0.975)*sd(AvgSpeed)/sqrt(n()), 
            Mean_avg_area = mean(AvgArea), 
            Error_mean_avg_area = qnorm(0.975)*sd(AvgArea)/sqrt(n()), 
            Mean_avg_perim = mean(AvgPerim), 
            Error_mean_avg_perim = qnorm(0.975)*sd(AvgPerim)/sqrt(n()), 
            Mean_BLPS = mean(BLPS), 
            Error_mean_BLPS = qnorm(0.975)*sd(BLPS)/sqrt(n()), 
            Broad_cat = Ind_vs_Comb[1])
```

##### All groups on same plot

###### Average speed
```{r}
ggplot(mov_summary_low_cleaned, aes(x = Day, y = Mean_avg_speed, colour = Group, 
                                    ymin = Mean_avg_speed - Error_mean_avg_speed, 
                                    ymax = Mean_avg_speed + Error_mean_avg_speed)) +
  geom_point() +
  geom_line(aes(group = Group)) +
  geom_errorbar(width = 0.2) +
  scale_colour_manual(values = cb_friendly_palette)
```

###### Max speed
```{r}
ggplot(mov_summary_low_cleaned, aes(x = Day, y = Mean_max_speed, colour = Group, 
                                    ymin = Mean_max_speed - Error_mean_max_speed, 
                                    ymax = Mean_max_speed + Error_mean_max_speed)) +
  geom_point() +
  geom_line(aes(group = Group)) +
  geom_errorbar(width = 0.2) +
  scale_colour_manual(values = cb_friendly_palette)
```

##### Each group in separate facet

###### Average speed
```{r}
ggplot(mov_summary_low_cleaned, aes(x = Day, y = Mean_avg_speed, colour = Group, 
                                    ymin = Mean_avg_speed - Error_mean_avg_speed, 
                                    ymax = Mean_avg_speed + Error_mean_avg_speed)) +
  geom_point() +
  geom_line(aes(group = Group)) +
  geom_errorbar(width = 0.2) +
  facet_wrap(~Group) +
  scale_colour_manual(values = cb_friendly_palette)
```

###### Max speed
```{r}
ggplot(mov_summary_low_cleaned, aes(x = Day, y = Mean_max_speed, colour = Group, 
                                    ymin = Mean_max_speed - Error_mean_max_speed, 
                                    ymax = Mean_max_speed + Error_mean_max_speed)) +
  geom_point() +
  geom_line(aes(group = Group)) +
  geom_errorbar(width = 0.2) +
  facet_wrap(~Group) +
  scale_colour_manual(values = cb_friendly_palette)
```

### All data points

#### Average speed
```{r}
ggplot(mov_low_cleaned, aes(x = Day, y = AvgSpeed, colour = Group)) +
  geom_point() +
  facet_wrap(~Group) +
  scale_colour_manual(values = cb_friendly_palette)
```

#### Max speed
```{r}
ggplot(mov_low_cleaned, aes(x = Day, y = MaxSpeed, colour = Group)) +
  geom_point() +
  facet_wrap(~Group) +
  scale_colour_manual(values = cb_friendly_palette)
```

## Log-transformed speed variables

### Change in group means over time

Create a new data frame with the change in group means over time
```{r}
mov_summary_low_cleaned_logged = mov_low_cleaned %>% group_by(Group, Day) %>% 
  summarise(Mean_length = mean(Length), 
            Error_mean_length = qnorm(0.975)*sd(Length)/sqrt(n()), 
            Mean_distance = mean(Distance), 
            Error_mean_distance = qnorm(0.975)*sd(Distance)/sqrt(n()), 
            Mean_log_max_speed = mean(log(MaxSpeed)), 
            Error_mean_log_max_speed = qnorm(0.975)*sd(log(MaxSpeed))/sqrt(n()), 
            Mean_log_avg_speed = mean(log(AvgSpeed)), 
            Error_mean_log_avg_speed = qnorm(0.975)*sd(log(AvgSpeed))/sqrt(n()), 
            Mean_avg_area = mean(AvgArea), 
            Error_mean_avg_area = qnorm(0.975)*sd(AvgArea)/sqrt(n()), 
            Mean_avg_perim = mean(AvgPerim), 
            Error_mean_avg_perim = qnorm(0.975)*sd(AvgPerim)/sqrt(n()), 
            Mean_log_BLPS = mean(log(BLPS)), 
            Error_mean_log_BLPS = qnorm(0.975)*sd(log(BLPS))/sqrt(n()), 
            Broad_cat = Ind_vs_Comb[1])
```

##### All groups on same plot

###### Average speed
```{r}
ggplot(mov_summary_low_cleaned_logged, aes(x = Day, y = Mean_log_avg_speed, colour = Group, 
                                           ymin = Mean_log_avg_speed - Error_mean_log_avg_speed,
                                           ymax = Mean_log_avg_speed + Error_mean_log_avg_speed)) +
  geom_point() +
  geom_line(aes(group = Group)) +
  geom_errorbar(width = 0.2) +
  scale_colour_manual(values = cb_friendly_palette)
```

###### Max speed
```{r}
ggplot(mov_summary_low_cleaned_logged, aes(x = Day, y = Mean_log_max_speed, colour = Group, 
                                           ymin = Mean_log_max_speed - Error_mean_log_max_speed,
                                           ymax = Mean_log_max_speed + Error_mean_log_max_speed)) +
  geom_point() +
  geom_line(aes(group = Group)) +
  geom_errorbar(width = 0.2) +
  scale_colour_manual(values = cb_friendly_palette)
```

##### Each group in separate facet

###### Average speed
```{r}
ggplot(mov_summary_low_cleaned_logged, aes(x = Day, y = Mean_log_avg_speed, colour = Group, 
                                           ymin = Mean_log_avg_speed - Error_mean_log_avg_speed,
                                           ymax = Mean_log_avg_speed + Error_mean_log_avg_speed)) +
  geom_point() +
  geom_line(aes(group = Group)) +
  geom_errorbar(width = 0.2) +
  facet_wrap(~Group) +
  scale_colour_manual(values = cb_friendly_palette)
```

###### Max speed
```{r}
ggplot(mov_summary_low_cleaned_logged, aes(x = Day, y = Mean_log_max_speed, colour = Group, 
                                           ymin = Mean_log_max_speed - Error_mean_log_max_speed,
                                           ymax = Mean_log_max_speed + Error_mean_log_max_speed)) +
  geom_point() +
  geom_line(aes(group = Group)) +
  geom_errorbar(width = 0.2) +
  facet_wrap(~Group) +
  scale_colour_manual(values = cb_friendly_palette)
```

### All data points

##### Average speed
```{r}
ggplot(mov_low_cleaned, aes(x = Day, y = log(AvgSpeed), colour = Group)) +
  geom_point() +
  facet_wrap(~Group) +
  scale_colour_manual(values = cb_friendly_palette)
```

##### Max speed
```{r}
ggplot(mov_low_cleaned, aes(x = Day, y = log(MaxSpeed), colour = Group)) +
  geom_point() +
  facet_wrap(~Group) +
  scale_colour_manual(values = cb_friendly_palette)
```

# Survival probabilities - NOT USED

## Match the survival probabilities from the lifespan data to the corresponding time points when movement measurements were made
```{r}
# First, add a space on either side of the "+" in the Group names in the lifespan data
lifespan = lifespan %>% mutate(Group = str_replace_all(Group, "\\+", " + "))

# Extract the survival probabilities for the LOW contamination worms
surv_prob_low = fortify(survfit(Surv(Time, NaturalDeath) ~ Group, data = filter(lifespan, Contam_Level_Binary == "Low")))

# Create a vector with the names of all 8 groups
groups = unique(surv_prob_low$strata)

# Remove unnecessary spaces from the group names
groups = str_replace_all(groups, "   ", " ")
surv_prob_low$strata = str_replace_all(surv_prob_low$strata, "   ", " ")

# Initialise an empty column in the movement data to contain the survival probabilities
mov_low$Surv_prob = NA

# Match the survival probabilities to the days on which movement measurements were made
for(i in 1:length(groups)){ # for each group
  for(j in 1:length(mov_low[mov_low$Group == groups[i], ]$Day)){ # for every movement observation of a given group
    temp = min(surv_prob_low[surv_prob_low$strata == groups[i], ]$time) # take the minimum day that has a survival probability associated with it for the given group
    for(k in 1:length(surv_prob_low[surv_prob_low$strata == groups[i], ]$time)){ # for each observation with a survival probability for the given group
      if(mov_low[mov_low$Group == groups[i], ]$Day[j] >= surv_prob_low[surv_prob_low$strata == groups[i], ]$time[k] & surv_prob_low[surv_prob_low$strata == groups[i], ]$time[k] >= temp){ # check whether the day of the movement observation is greater than the day of the survival probability observation AND whether the day of the survival probability observation is greater than the previously highest day
        mov_low[mov_low$Group == groups[i], ]$Surv_prob[j] = surv_prob_low[surv_prob_low$strata == groups[i], ]$surv[k] # assign the survival probability of the observation that meets the above criteria to the relevant movement observation
        temp = surv_prob_low[surv_prob_low$strata == groups[i], ]$time[k] # variable for comparing subsequent day values is updated with the new largest day for a survival probability observation discovered so far
      }
    }
  }
}

# Fill in the survival probabilities that remained as NAs with "1". They remained as NAs because there were no survival probability observations for a group (in this case, MET + NMN) that were earlier than the earliest movement observation.
mov_low[is.na(mov_low$Surv_prob), ]$Surv_prob = 1
```

## Plot the change in movement for each group as survival probability decreases
```{r}
(ggplot(mov_low, aes(x = Surv_prob, y = AvgSpeed, colour = Group)) +
  geom_point() +
  scale_x_reverse() +
  facet_wrap(~ Group)) +
  scale_colour_manual(values = cb_friendly_palette)
```

# MODELS

## WITHOUT artefacts

### LOW contamination

#### Check for normality of the response variables
```{r}
hist(mov_low_cleaned$AvgSpeed) # not normal - a bit skewed

hist(mov_low_cleaned$MaxSpeed) # not normal - a bit skewed

hist(log(mov_low_cleaned$AvgSpeed)) # normal

hist(log(mov_low_cleaned$MaxSpeed)) # normal
```

#### Average speed

##### Model construction
```{r}
# Linear model with:
# - response variable: average speed
# - fixed effects: group, day, all group*day interactions, day^2, and all group*(day^2) interactions
# - random effect: plate
summary(lmer(AvgSpeed ~ Group + Day + Group*Day + I(Day^2) + Group*I(Day^2) + (1|GroupPlate), data = mov_low_cleaned, REML = F))

# Linear model with:
# - response variable: average speed
# - fixed effects: group, log(day), and all group*log(day) interactions
# - random effect: plate
summary(lmer(AvgSpeed ~ Group + log(Day) + Group*log(Day) + (1|GroupPlate), data = mov_low_cleaned, REML = F))

# When comparing the above two models, we can see that the Bayesian Information Criterion (BIC) is smaller for the model with log-transformed time (BIC = -2108) rather than the model with quadratic effects of time (BIC = -2075). Therefore, the model with log-transformed time is better.

# Linear model with:
# - response variable: log-transformed average speed
# - fixed effects: group, day, all group*day interactions, day^2, and all group*(day^2) interactions
# - random effect: plate
summary(lmer(log(AvgSpeed) ~ Group + Day + Group*Day + I(Day^2) + Group*I(Day^2) + (1|GroupPlate), data = mov_low_cleaned, REML = F))

# Linear model with:
# - response variable: log-transformed average speed
# - fixed effects: group, log(day), and all group*log(day) interactions
# - random effect: plate
summary(lmer(log(AvgSpeed) ~ Group + log(Day) + Group*log(Day) + (1|GroupPlate), data = mov_low_cleaned, REML = F))

# When comparing the above two models with log-transformed average speed, we can see that the BIC is smaller for the model with log-transformed time (BIC = 126.9) rather than the model with quadratic effects of time (BIC = 156.6). Therefore, the model with log-transformed time is better.

# Since plate doesn't explain any of the variance in either of the models, remove it from the models

# Model with average speed
lm_avg_speed_not_logged = lm(AvgSpeed ~ Group + log(Day) + Group*log(Day), data = mov_low_cleaned)
summary(lm_avg_speed_not_logged)

# Model with log-transformed average speed
lm_avg_speed_logged = lm(log(AvgSpeed) ~ Group + log(Day) + Group*log(Day), data = mov_low_cleaned)
summary(lm_avg_speed_logged)

# Keep all remaining terms in the models, as their estimates are significantly different from 0

# Check the residuals for the model where average speed is not log-transformed
res_lm_avg_speed_not_logged = resid(lm_avg_speed_not_logged)
hist(res_lm_avg_speed_not_logged) # histogram of the residuals
plot(lm_avg_speed_not_logged) # diagnostic plots

# Check the residuals for the model where average speed is log-transformed
res_lm_avg_speed_logged = resid(lm_avg_speed_logged)
hist(res_lm_avg_speed_logged) # histogram of the residuals
plot(lm_avg_speed_logged) # diagnostic plots

# Based on the above analysis of the residuals, the model using the log-transformed average speed (i.e., lm_avg_speed_logged) is slightly better, and will be used for the rest of the analysis
summary(lm_avg_speed_logged)
```

##### Check whether the effects of intervention combinations are additive, antagonistic, or synergistic
```{r}
# List all fixed effects separately so that the model summary contains information on whether the interactive effects (i.e., the slopes of the combination groups) differ from additive
factorial_lm_avg_speed_logged = lm(log(AvgSpeed) ~ MET + NMN + CR + MET*NMN + MET*CR + NMN*CR + MET*NMN*CR + log(Day) + MET*log(Day) + NMN*log(Day) + CR*log(Day) + MET*NMN*log(Day) + MET*CR*log(Day) + NMN*CR*log(Day) + MET*NMN*CR*log(Day), data = mov_low_cleaned)

# View the model summary
summary(factorial_lm_avg_speed_logged)

# CONCLUSION: From the model summary, it seems that all interactive effects are not statistically different from additive.
```

##### Extract the slope coefficients for each group, as well as the estimates of the differences in slopes for all pairwise groups comparisons
```{r}
# No correction for multiple comparisons
lstrends(lm_avg_speed_logged, pairwise ~ Group, var = "log(Day)", adjust = "NO")

# CONCLUSIONS: Significantly different slopes (no correction):
# - Control and:
#   - CR
#   - NMN + CR
# - CR and:
#   - MET
#   - MET + CR
#   - MET + NMN
#   - MET + NMN + CR
#   - NMN
# - MET and:
#   - NMN + CR
# - MET + CR and:
#   - MET + NMN
# - MET + NMN and:
#   - MET + NMN + CR
#   - NMN + CR
# - MET + NMN + CR and:
#   - NMN + CR
# - NMN and:
#   - NMN + CR

# Bonferroni correction for multiple comparisons
avg_speed_slope_diff_adj_pval = lstrends(lm_avg_speed_logged, pairwise ~ Group, var = "log(Day)", adjust = "Bonferroni")
avg_speed_slope_diff_adj_pval

# CONCLUSIONS: Significantly different slopes (with Bonferroni correction):
# - Control and:
#   - CR
#   - NMN + CR
# - MET and:
#   - CR
#   - NMN + CR
# - NMN and:
#   - CR
# - CR and:
#   - MET + NMN
#   - MET + NMN + CR
# - MET + NMN and:
#   - NMN + CR
```

##### Plot - all data points with predictions

###### Manually make predictions
```{r}
# First, write down the intercepts and slopes for each group
# Control
# - Intercept: -3.09403
# - Slope: -0.1480
# MET
# - Intercept: -3.11939
# - Slope: -0.1329
# NMN
# - Intercept: -3.08309
# - Slope: -0.1620
# CR
# - Intercept: -1.92166
# - Slope: -0.5824
# MET + NMN
# - Intercept: -3.37183
# - Slope: -0.0526
# MET + CR
# - Intercept: -2.83533
# - Slope: -0.3231
# NMN + CR
# - Intercept: -2.05868
# - Slope: -0.4860
# MET + NMN + CR
# - Intercept: -2.76727
# - Slope: -0.2498

# Create a data frame that has six columns:
# - Group: the name of the group for which the prediction is
# - Day: the day for which the prediction is
# - Intercept: the intercept in the prediction formula
# - Slope: the slope in the prediction formula
# - Pred: the prediction
# - Transf_Pred: the transformed prediction, so that it can be plotted on a plot with non-transformed axes
avg_speed_pred = tibble(Group = c(rep("Control", times = 35), 
                                  rep("MET", times = 35), 
                                  rep("NMN", times = 35), 
                                  rep("CR", times = 35), 
                                  rep("MET + NMN", times = 35), 
                                  rep("MET + CR", times = 35), 
                                  rep("NMN + CR", times = 35), 
                                  rep("MET + NMN + CR", times = 35)), 
                        Day = c(rep(4:38, times = 8)), 
                        Intercept = c(rep(-3.09403, times = 35), 
                                      rep(-3.11939, times = 35), 
                                      rep(-3.08309, times = 35), 
                                      rep(-1.92166, times = 35), 
                                      rep(-3.37183, times = 35), 
                                      rep(-2.83533, times = 35), 
                                      rep(-2.05868, times = 35), 
                                      rep(-2.76727, times = 35)), 
                        Slope = c(rep(-0.1480, times = 35), 
                                  rep(-0.1329, times = 35), 
                                  rep(-0.1620, times = 35), 
                                  rep(-0.5824, times = 35), 
                                  rep(-0.0526, times = 35), 
                                  rep(-0.3231, times = 35), 
                                  rep(-0.4860, times = 35), 
                                  rep(-0.2498, times = 35)), 
                        Pred = Slope*log(Day) + Intercept, 
                        Transf_Pred = 2.71^Pred)

# Plot the predictions on the plot with each group's data points in a separate facet
ggplot(mov_low_cleaned, aes(x = Day, y = AvgSpeed, colour = Group)) +
  geom_point() +
  geom_line(data = avg_speed_pred, aes(x = Day, y = Transf_Pred, colour = Group), size = 0.75) +
  facet_wrap(~Group) +
  scale_colour_manual(values = cb_friendly_palette)
```

###### Use generated predictions
```{r}
# Create a data frame that contains all possible Day-Group combinations. Each combination will be used as a set of predictors when making a single prediction about avg speed based on the model.
avg_speed_predictors = expand.grid(Day = seq(4, 38, length.out = 35), Group = as.factor(levels(mov_low_cleaned$Group)))

# Generate a data frame with the predictions (and associated SEs) based on the predictors and the model
avg_speed_predictions = as.data.frame(predict(lm_avg_speed_logged, newdata = avg_speed_predictors, type = "response", se.fit = TRUE))

# Combine the two data frames
avg_speed_predictions = cbind(avg_speed_predictors, avg_speed_predictions)

# Reorder the group levels
avg_speed_predictions$Group = fct_relevel(avg_speed_predictions$Group, "Control", "MET", "NMN", "CR", "MET + NMN", "MET + CR", "NMN + CR", "MET + NMN + CR")

# Plot the predictions with their 95% CIs over the actual data points
ggplot() +
  geom_ribbon(data = avg_speed_predictions, aes(x = Day, ymin = exp(fit - 1.96*se.fit), ymax = exp(fit + 1.96*se.fit), colour = Group, fill = Group), outline.type = "full", alpha = 0.2, show.legend = FALSE) +
  geom_point(data = mov_low_cleaned, aes(x = Day, y = AvgSpeed, colour = Group)) +
  geom_line(data = avg_speed_predictions, aes(x = Day, y = exp(fit), colour = Group), size = 0.75) +
  ggtitle("Average speed values and model predictions by group") +
  xlab("Day of adulthood") +
  ylab("Average speed (mm/s)") +
  facet_wrap(~Group) +
  scale_x_continuous(expand = c(0, 0), limits = c(-2, 42)) +
  scale_colour_manual(values = cb_friendly_palette) + 
  scale_fill_manual(values = cb_friendly_palette) + 
  theme_bw() + 
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0.5), 
        axis.text = element_text(size = 10), 
        axis.title = element_text(size = 12), 
        axis.title.x = element_text(vjust = -1), 
        axis.title.y = element_text(vjust = 3), 
        legend.title = element_blank())
```

##### Construct and plot a matrix with the adjusted p-values for all pairwise group comparisons of slopes
```{r}
# Extract exact p-values
summary(avg_speed_slope_diff_adj_pval$contrasts)$p.value

# Construct matrix
p_val_avg_speed_slope_diff = matrix(
  #Sequence of p-values
  c(NA, 1, 1, 1.804582e-04, 1, 1, 4.023071e-02, 1, 
    NA, NA, 1, 3.488720e-05, 1, 1, 1.658234e-02, 1, 
    NA, NA, NA, 3.022213e-04, 1, 1, 5.901018e-02, 1, 
    NA, NA, NA, NA, 2.286236e-06, 8.523924e-01, 1, 8.165495e-03, 
    NA, NA, NA, NA, NA, 5.389270e-01, 1.727906e-03, 5.884469e-01, 
    NA, NA, NA, NA, NA, NA, 1, 1, 
    NA, NA, NA, NA, NA, NA, NA, 5.811496e-01, 
    NA, NA, NA, NA, NA, NA, NA, NA),
  nrow = 8, # Number of rows
  ncol = 8 # Number of columns
  )

# Name the rows
rownames(p_val_avg_speed_slope_diff) = c("Control", "MET", "NMN", "CR", "MET + NMN", "MET + CR", "NMN + CR", "MET + NMN + CR")

# Name the columns
colnames(p_val_avg_speed_slope_diff) = c("Control", "MET", "NMN", "CR", "MET + NMN", "MET + CR", "NMN + CR", "MET + NMN + CR")

# Print out the 8x8 matrix
cat("The 8x8 matrix:\n")
print(p_val_avg_speed_slope_diff)

# Create a colour blind-friendly palette for the plot
cb_friendly_p_val = c("(0, 0.0001]" = "#08306B", 
                      "(0.0001, 0.001]" = "#08519C", 
                      "(0.001, 0.01]" = "#2171B5", 
                      "(0.01, 0.05]" = "#4292C6", 
                      "(0.05, 1]" = "#A50026", 
                      " " = "white")

# Transform the matrix into a data frame
p_val_avg_speed_melt = melt.matrix(p_val_avg_speed_slope_diff)

# Convert the group names into factors
p_val_avg_speed_melt$X1 = as.factor(p_val_avg_speed_melt$X1)
p_val_avg_speed_melt$X2 = as.factor(p_val_avg_speed_melt$X2)

# Create a new column that categorises the p-values
p_val_avg_speed_melt$value_cat = cut(p_val_avg_speed_melt$value, 
                                     breaks = c(0, 0.0001, 0.001, 0.01, 0.05, 1), 
                                     right = TRUE)

# Add a space between the numbers denoting the interval categories
p_val_avg_speed_melt$value_cat = str_replace_all(p_val_avg_speed_melt$value_cat, ",", ", ")

# Assign all the comparisons for which a p-value of 0 was provided (and hence had NAs assigned to them in the new column) the level " " in the new column
p_val_avg_speed_melt[is.na(p_val_avg_speed_melt$value_cat), ]$value_cat = " "

# Convert back to factor (as the above manipulations changed it to character) and re-specify the factor levels
p_val_avg_speed_melt$value_cat = factor(p_val_avg_speed_melt$value_cat, 
                                        levels = c("(0, 0.0001]", 
                                                   "(0.0001, 0.001]", 
                                                   "(0.001, 0.01]", 
                                                   "(0.01, 0.05]", 
                                                   "(0.05, 1]", 
                                                   " "))

# Convert the precise p-values into scientific format with one decimal place
p_val_avg_speed_melt$value = format(p_val_avg_speed_melt$value, format = "e", digits = 2)

# Plot the p-values
ggplot(p_val_avg_speed_melt, aes(X1, X2)) +
  geom_tile(aes(fill = value_cat), color = "white", size = 0.5) +
  geom_text(aes(label = value), size = 3, colour = "white") +
  scale_fill_manual(values = cb_friendly_p_val, drop = FALSE) +
  labs(fill = "p-value") +
  ggtitle("P-values for comparisons between rates of decline in average speed") +
  theme(axis.line = element_blank(), 
        axis.text = element_text(size = 10), 
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
        axis.ticks = element_blank(), 
        axis.title = element_blank(), 
        legend.key = element_rect(fill = "white"), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        plot.title = element_text(face = "bold", hjust = 0.5, size = 14))
```



#### Max speed

##### Model construction
```{r}
# Linear model with:
# - response variable: max speed
# - fixed effects: group, day, all group*day interactions, day^2, and all group*(day^2) interactions
# - random effect: plate
summary(lmer(MaxSpeed ~ Group + Day + Group*Day + I(Day^2) + Group*I(Day^2) + (1|GroupPlate), data = mov_low_cleaned, REML = F))

# Linear model with:
# - response variable: max speed
# - fixed effects: group, log(day), and all group*log(day) interactions
# - random effect: plate
summary(lmer(MaxSpeed ~ Group + log(Day) + Group*log(Day) + (1|GroupPlate), data = mov_low_cleaned, REML = F))

# When comparing the above two models, we can see that the Bayesian Information Criterion (BIC) is smaller for the model with log-transformed time (BIC = -896) rather than the model with quadratic effects of time (BIC = -865.5). Therefore, the model with log-transformed time is better.

# Linear model with:
# - response variable: log-transformed max speed
# - fixed effects: group, day, all group*day interactions, day^2, and all group*(day^2) interactions
# - random effect: plate
summary(lmer(log(MaxSpeed) ~ Group + Day + Group*Day + I(Day^2) + Group*I(Day^2) + (1|GroupPlate), data = mov_low_cleaned, REML = F))

# Linear model with:
# - response variable: log-transformed max speed
# - fixed effects: group, log(day), and all group*log(day) interactions
# - random effect: plate
summary(lmer(log(MaxSpeed) ~ Group + log(Day) + Group*log(Day) + (1|GroupPlate), data = mov_low_cleaned, REML = F))

# When comparing the above two models with log-transformed max speed, we can see that the BIC is smaller for the model with log-transformed time (BIC = 327.7) rather than the model with quadratic effects of time (BIC = 357.3). Therefore, the model with log-transformed time is better.

# Since plate doesn't explain any of the variance in either of the models, remove it from the models

# Model with max speed
lm_max_speed_not_logged = lm(MaxSpeed ~ Group + log(Day) + Group*log(Day), data = mov_low_cleaned)
summary(lm_max_speed_not_logged)

# Model with log-transformed max speed
lm_max_speed_logged = lm(log(MaxSpeed) ~ Group + log(Day) + Group*log(Day), data = mov_low_cleaned)
summary(lm_max_speed_logged)

# Keep all remaining terms in the models, as their estimates are significantly different from 0. Log(day) has to be kept as well, even though its estimate is not significantly different from 0, because there are significant group*log(day) interactions.

# Check the residuals for the model where max speed is not log-transformed
res_lm_max_speed_not_logged = resid(lm_max_speed_not_logged)
hist(res_lm_max_speed_not_logged) # histogram of the residuals
plot(lm_max_speed_not_logged) # diagnostic plots

# Check the residuals for the model where max speed is log-transformed
res_lm_max_speed_logged = resid(lm_max_speed_logged)
hist(res_lm_max_speed_logged) # histogram of the residuals
plot(lm_max_speed_logged) # diagnostic plots

# Based on the above analysis of the residuals, the model using the log-transformed max speed (i.e., lm_max_speed_logged) is a lot better, and will be used for the rest of the analysis
summary(lm_max_speed_logged)
```

##### Check whether the effects of intervention combinations are additive, antagonistic, or synergistic
```{r}
# List all fixed effects separately so that the model summary contains information on whether the interactive effects (i.e., the slopes of the combination groups) differ from additive
factorial_lm_max_speed_logged = lm(log(MaxSpeed) ~ MET + NMN + CR + MET*NMN + MET*CR + NMN*CR + MET*NMN*CR + log(Day) + MET*log(Day) + NMN*log(Day) + CR*log(Day) + MET*NMN*log(Day) + MET*CR*log(Day) + NMN*CR*log(Day) + MET*NMN*CR*log(Day), data = mov_low_cleaned)

# View the model summary
summary(factorial_lm_max_speed_logged)

# CONCLUSION: From the model summary, it seems that all interactive effects are not statistically different from additive.
```

##### Extract the slope coefficients for each group, as well as the estimates of the differences in slopes for all pairwise groups comparisons
```{r}
# No correction for multiple comparisons
lstrends(lm_max_speed_logged, pairwise ~ Group, var = "log(Day)", adjust = "NO")

# CONCLUSIONS: Significantly different slopes (at uncorrected alpha-level of 0.05):
# - Control and:
#   - CR
#   - NMN + CR
# - MET and:
#   - CR
#   - NMN + CR
# - NMN and:
#   - CR
#   - NMN + CR
# - MET + NMN and:
#   - NMN + CR

# Bonferroni correction for multiple comparisons
max_speed_slope_diff_adj_pval = lstrends(lm_max_speed_logged, pairwise ~ Group, var = "log(Day)", adjust = "Bonferroni")
max_speed_slope_diff_adj_pval

# CONCLUSIONS: No significantly different slopes (with Bonferroni correction)
```

##### Plot - all data points with predictions

###### Manually make predictions
```{r}
# First, write down the intercepts and slopes for each group
# Control
# - Intercept: -1.54465
# - Slope: -0.134
# MET
# - Intercept: -1.51966
# - Slope: -0.163
# NMN
# - Intercept: -1.51607
# - Slope: -0.166
# CR
# - Intercept: -0.85133
# - Slope: -0.425
# MET + NMN
# - Intercept: -1.46164
# - Slope: -0.189
# MET + CR
# - Intercept: -1.25823
# - Slope: -0.362
# NMN + CR
# - Intercept: -0.49412
# - Slope: -0.509
# MET + NMN + CR
# - Intercept: -1.15901
# - Slope: -0.295

# Create a data frame that has six columns:
# - Group: the name of the group for which the prediction is
# - Day: the day for which the prediction is
# - Intercept: the intercept in the prediction formula
# - Slope: the slope in the prediction formula
# - Pred: the prediction
# - Transf_Pred: the transformed prediction, so that it can be plotted on a plot with non-transformed axes
max_speed_pred = tibble(Group = c(rep("Control", times = 35), 
                                  rep("MET", times = 35), 
                                  rep("NMN", times = 35), 
                                  rep("CR", times = 35), 
                                  rep("MET + NMN", times = 35), 
                                  rep("MET + CR", times = 35), 
                                  rep("NMN + CR", times = 35), 
                                  rep("MET + NMN + CR", times = 35)), 
                        Day = c(rep(4:38, times = 8)), 
                        Intercept = c(rep(-1.54465, times = 35), 
                                      rep(-1.51966, times = 35), 
                                      rep(-1.51607, times = 35), 
                                      rep(-0.85133, times = 35), 
                                      rep(-1.46164, times = 35), 
                                      rep(-1.25823, times = 35), 
                                      rep(-0.49412, times = 35), 
                                      rep(-1.15901, times = 35)), 
                        Slope = c(rep(-0.134, times = 35), 
                                  rep(-0.163, times = 35), 
                                  rep(-0.166, times = 35), 
                                  rep(-0.425, times = 35), 
                                  rep(-0.189, times = 35), 
                                  rep(-0.362, times = 35), 
                                  rep(-0.509, times = 35), 
                                  rep(-0.295, times = 35)), 
                        Pred = Slope*log(Day) + Intercept, 
                        Transf_Pred = 2.71^Pred)

# Plot the predictions on the plot with each group's data points in a separate facet
ggplot(mov_low_cleaned, aes(x = Day, y = MaxSpeed, colour = Group)) +
  geom_point() +
  geom_line(data = max_speed_pred, aes(x = Day, y = Transf_Pred, colour = Group), size = 0.75) +
  facet_wrap(~Group) +
  scale_colour_manual(values = cb_friendly_palette)
```

###### Use generated predictions
```{r}
# Create a data frame that contains all possible Day-Group combinations. Each combination will be used as a set of predictors when making a single prediction about max speed based on the model.
max_speed_predictors = expand.grid(Day = seq(4, 38, length.out = 35), Group = as.factor(levels(mov_low_cleaned$Group)))

# Generate a data frame with the predictions (and associated SEs) based on the predictors and the model
max_speed_predictions = as.data.frame(predict(lm_max_speed_logged, newdata = max_speed_predictors, type = "response", se.fit = TRUE))

# Combine the two data frames
max_speed_predictions = cbind(max_speed_predictors, max_speed_predictions)

# Reorder the group levels
max_speed_predictions$Group = fct_relevel(max_speed_predictions$Group, "Control", "MET", "NMN", "CR", "MET + NMN", "MET + CR", "NMN + CR", "MET + NMN + CR")

# Plot the predictions with their 95% CIs over the actual data points
ggplot() +
  geom_ribbon(data = max_speed_predictions, aes(x = Day, ymin = exp(fit - 1.96*se.fit), ymax = exp(fit + 1.96*se.fit), colour = Group, fill = Group), outline.type = "full", alpha = 0.2, show.legend = FALSE) +
  geom_point(data = mov_low_cleaned, aes(x = Day, y = MaxSpeed, colour = Group)) +
  geom_line(data = max_speed_predictions, aes(x = Day, y = exp(fit), colour = Group), size = 0.75) +
  ggtitle("Maximum speed values and model predictions by group") +
  xlab("Day of adulthood") +
  ylab("Maximum speed (mm/s)") +
  facet_wrap(~Group) +
  scale_x_continuous(expand = c(0, 0), limits = c(-2, 42)) +
  scale_colour_manual(values = cb_friendly_palette) + 
  scale_fill_manual(values = cb_friendly_palette) + 
  theme_bw() +
  theme(plot.title = element_text(face = "bold", size = 14, hjust = 0.5), 
        axis.text = element_text(size = 10), 
        axis.title = element_text(size = 12), 
        axis.title.x = element_text(vjust = -1), 
        axis.title.y = element_text(vjust = 3), 
        legend.title = element_blank())
```

##### Construct and plot a matrix with the p-values for all pairwise group comparisons of slopes
```{r}
# Extract exact p-values
summary(max_speed_slope_diff_adj_pval$contrasts)$p.value

p_val_max_speed_slope_diff = matrix(
  # Sequence of p-values
  c(NA, 1, 1, 0.6558432, 1, 1, 0.2399038, 1, 
    NA, NA, 1, 0.9329219, 1, 1, 0.3387577, 1, 
    NA, NA, NA, 1, 1, 1, 0.4325824, 1, 
    NA, NA, NA, NA, 1, 1, 1, 1, 
    NA, NA, NA, NA, NA, 1, 0.7512726, 1, 
    NA, NA, NA, NA, NA, NA, 1, 1, 
    NA, NA, NA, NA, NA, NA, NA, 1, 
    NA, NA, NA, NA, NA, NA, NA, NA),
  nrow = 8, # Number of rows
  ncol = 8 # Number of columns   
)

# Name the rows
rownames(p_val_max_speed_slope_diff) = c("Control", "MET", "NMN", "CR", "MET + NMN", "MET + CR", "NMN + CR", "MET + NMN + CR")

# Name the columns
colnames(p_val_max_speed_slope_diff) = c("Control", "MET", "NMN", "CR", "MET + NMN", "MET + CR", "NMN + CR", "MET + NMN + CR")

# Print out the 8x8 matrix
cat("The 8x8 matrix:\n")
print(p_val_max_speed_slope_diff)

# Transform the matrix into a data frame
p_val_max_speed_melt = melt.matrix(p_val_max_speed_slope_diff)

# Convert the group names into factors
p_val_max_speed_melt$X1 = as.factor(p_val_max_speed_melt$X1)
p_val_max_speed_melt$X2 = as.factor(p_val_max_speed_melt$X2)

# Create a new column that categorises the p-values
p_val_max_speed_melt$value_cat = cut(p_val_max_speed_melt$value, 
                                     breaks = c(0, 0.0001, 0.001, 0.01, 0.05, 1), 
                                     right = TRUE)

# Add a space between the numbers denoting the interval categories
p_val_max_speed_melt$value_cat = str_replace_all(p_val_max_speed_melt$value_cat, ",", ", ")

# Assign all the comparisons for which a p-value of 0 was provided (and hence had NAs assigned to them in the new column) the level " " in the new column
p_val_max_speed_melt[is.na(p_val_max_speed_melt$value_cat), ]$value_cat = " "

# Convert back to factor (as the above manipulations changed it to character) and re-specify the factor levels
p_val_max_speed_melt$value_cat = factor(p_val_max_speed_melt$value_cat, 
                                        levels = c("(0, 0.0001]", 
                                                   "(0.0001, 0.001]", 
                                                   "(0.001, 0.01]", 
                                                   "(0.01, 0.05]", 
                                                   "(0.05, 1]", 
                                                   " "))

# Convert the precise p-values into scientific format with one decimal place
p_val_max_speed_melt$value = format(p_val_max_speed_melt$value, format = "e", digits = 2)

# Plot the p-values
ggplot(p_val_max_speed_melt, aes(X1, X2)) +
  geom_tile(aes(fill = value_cat), color = "white", size = 0.5) +
  geom_text(aes(label = value), size = 3, colour = "white") +
  scale_fill_manual(values = cb_friendly_p_val, drop = FALSE) +
  labs(fill = "p-value") +
  ggtitle("P-values for comparisons between rates of decline in maximum speed") +
  theme(axis.line = element_blank(), 
        axis.text = element_text(size = 10), 
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), 
        axis.ticks = element_blank(), 
        axis.title = element_blank(), 
        legend.key = element_rect(fill = "white"), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        plot.title = element_text(face = "bold", hjust = 0.5, size = 14))
```

## NOT USED - WITH artefacts

### All worms
```{r}
# Linear model with average speed as the response variable, group and day as fixed effects, group*day as an interactive effect, and plate as a random effect
summary(lmer(AvgSpeed ~ Group + Day + Group*Day + (1|GroupPlate), data = mov))

# Linear model with max speed as the response variable, group and day as fixed effects, group*day as an interactive effect, and plate as a random effect
summary(lmer(MaxSpeed ~ Group + Day + Group*Day + (1|GroupPlate), data = mov))

# Since plate doesn't seem to have a significant effect, fit the models only with group and day as fixed effects, and with group*day as an interactive effect
a = lm(log(AvgSpeed) ~ Group + Day + Group*Day + I(Day^2) + Group*I(Day^2), data = mov)
summary(a)

c = lm(log(AvgSpeed) ~ Group + Day + Group*Day + I(Day^2), data = mov)
summary(c)

b = lm(log(AvgSpeed) ~ Group + Day + Group*Day, data = mov)
summary(b)

# Compare the models
anova(b, c)

# How to extract various values from a model:
# coef  = coefficients(fit)       # coefficients
# resid = residuals(fit)          # residuals
# pred  = predict(c)              # fitted values
# rsq   = summary(fit)$r.squared  # R-sq for the fit
# se    = summary(fit)$sigma      # se of the fit
```

### LOW contamination

#### Check for normality of the response variables
```{r}
hist(mov_low$AvgSpeed) # not normal - a bit skewed

hist(mov_low$MaxSpeed) # not normal - very skewed

hist(log(mov_low$AvgSpeed)) # normal

hist(log(mov_low$MaxSpeed)) # reasonably normal
```

#### Average speed
```{r}
# Linear model with average speed as the response variable, group and day as fixed effects, group*day as an interactive effect, and plate as a random effect
summary(lmer(AvgSpeed ~ Group + Day + Group*Day + I(Day^2) + Group*I(Day^2) + (1|GroupPlate), data = mov_low))

summary(lmer(log(AvgSpeed) ~ Group + Day + Group*Day + I(Day^2) + Group*I(Day^2) + (1|GroupPlate), data = mov_low))

# Since plate doesn't explain any of the variance, remove it from the models
summary(lm(AvgSpeed ~ Group + Day + Group*Day + I(Day^2) + Group*I(Day^2), data = mov_low))

summary(lm(log(AvgSpeed) ~ Group + Day + Group*Day + I(Day^2) + Group*I(Day^2), data = mov_low))

# Since the estimates for Group*I(Day^2) are not significantly different from 0 (p > 0.05), remove it from the model
a = lm(AvgSpeed ~ Group + Day + Group*Day + I(Day^2), data = mov_low)
summary(a)

b = lm(log(AvgSpeed) ~ Group + Day + Group*Day + I(Day^2), data = mov_low)
summary(b)

# Keep all remaining terms in the model, as their estimates are significantly different from 0

# Check residuals
res_a = resid(a)
hist(res_a)
plot(a)
qqnorm(residuals(a))

res_b = resid(b)
hist(res_b)
plot(b)
qqnorm(residuals(b))
```

#### Max speed
```{r}
# Linear model with average speed as the response variable, group and day as fixed effects, group*day as an interactive effect, and plate as a random effect
summary(lmer(MaxSpeed ~ Group + Day + Group*Day + I(Day^2) + Group*I(Day^2) + (1|GroupPlate), data = mov_low)) # Has a little bit of variance for the random effect

summary(lmer(log(MaxSpeed) ~ Group + Day + Group*Day + I(Day^2) + Group*I(Day^2) + (1|GroupPlate), data = mov_low)) # No variance for the random effect
```